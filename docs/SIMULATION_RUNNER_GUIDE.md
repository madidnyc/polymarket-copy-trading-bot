# Simulation Runner Guide

Удобный инструмент для запуска и сравнения множественных симуляций copy trading с различными параметрами.

## Быстрый старт

### Интерактивный режим (рекомендуется)

Запустите интерактивное меню для настройки симуляций:

```bash
npm run sim
```

Вам будет предложено:
1. Выбрать пресет (quick/standard/full)
2. Указать адреса трейдеров (или использовать дефолтные)

### Готовые пресеты

```bash
# Быстрый тест (7 дней, 2 мультипликатора)
npm run sim quick

# Стандартный тест (30 дней, 3 мультипликатора) - РЕКОМЕНДУЕТСЯ
npm run sim standard

# Полный тест (90 дней, 4 мультипликатора)
npm run sim full
```

### Кастомная симуляция

```bash
npm run sim custom <trader_address> [days] [multiplier]

# Примеры:
npm run sim custom 0x7c3db723f1d4d8cb9c550095203b686cb11e5c6b 30 2.0
npm run sim custom 0x6bab41a0dc40d6dd4c1a915b8c01969479fd1292 60 1.5
```

## Пресеты

### Quick (Быстрый)
- **История:** 7 дней
- **Макс. трейдов:** 500
- **Мультипликаторы:** 1.0x, 2.0x
- **Время выполнения:** ~2-3 минуты
- **Когда использовать:** Быстрая проверка трейдера, первичный анализ

### Standard (Стандартный) ⭐ РЕКОМЕНДУЕТСЯ
- **История:** 30 дней
- **Макс. трейдов:** 2000
- **Мультипликаторы:** 0.5x, 1.0x, 2.0x
- **Время выполнения:** ~5-10 минут
- **Когда использовать:** Основной анализ перед началом копирования

### Full (Полный)
- **История:** 90 дней
- **Макс. трейдов:** 5000
- **Мультипликаторы:** 0.5x, 1.0x, 2.0x, 3.0x
- **Время выполнения:** ~15-30 минут
- **Когда использовать:** Глубокий анализ долгосрочной стратегии

## Сравнение результатов

После запуска симуляций используйте команду `compare` для анализа:

### Показать все результаты

```bash
npm run compare
```

Выводит:
- Таблицу всех симуляций по трейдерам
- Топ-5 лучших конфигураций
- 3 худших конфигурации
- Агрегированную статистику

### Топ результаты

```bash
# Показать топ-10 лучших
npm run compare best 10

# Топ-3
npm run compare best 3
```

### Худшие результаты

```bash
# Показать 5 худших
npm run compare worst 5
```

### Агрегированная статистика

```bash
npm run compare stats
```

Показывает:
- Общее количество симуляций
- Процент прибыльных/убыточных
- Средний ROI
- Средний P&L
- Общее количество скопированных/пропущенных трейдов

### Детальная информация

```bash
npm run compare detail <name_part>

# Примеры:
npm run compare detail std_m2p0
npm run compare detail 0x7c3d
```

## Примеры использования

### Сценарий 1: Оценка нового трейдера

```bash
# 1. Быстрая проверка
npm run sim custom 0x7c3db723f1d4d8cb9c550095203b686cb11e5c6b 7 1.0

# 2. Если результат хороший - полный анализ
npm run sim custom 0x7c3db723f1d4d8cb9c550095203b686cb11e5c6b 30 1.0

# 3. Тестирование разных мультипликаторов
npm run sim custom 0x7c3db723f1d4d8cb9c550095203b686cb11e5c6b 30 0.5
npm run sim custom 0x7c3db723f1d4d8cb9c550095203b686cb11e5c6b 30 2.0

# 4. Сравнение результатов
npm run compare
```

### Сценарий 2: Сравнение нескольких трейдеров

```bash
# Запуск стандартного теста для всех трейдеров
npm run sim standard

# Сравнение результатов
npm run compare

# Детальный просмотр лучшего
npm run compare best 1
```

### Сценарий 3: Оптимизация мультипликатора

```bash
# Тестирование одного трейдера с разными мультипликаторами
npm run sim custom 0x7c3d... 30 0.5
npm run sim custom 0x7c3d... 30 1.0
npm run sim custom 0x7c3d... 30 1.5
npm run sim custom 0x7c3d... 30 2.0
npm run sim custom 0x7c3d... 30 3.0

# Сравнение для выбора оптимального
npm run compare
```

## Структура результатов

Все результаты сохраняются в `simulation_results/`:

```
simulation_results/
├── new_logic_0x7c3d..._30d_std_m0p5_2025-10-22.json
├── new_logic_0x7c3d..._30d_std_m1p0_2025-10-22.json
├── new_logic_0x7c3d..._30d_std_m2p0_2025-10-22.json
└── ...
```

Формат имени файла:
```
new_logic_<trader>_<days>d_<tag>_<date>.json
```

### Формат JSON результата

```json
{
  "id": "sim_0x7c3db7_1729543210000",
  "name": "NEW_0x7c3d_30d",
  "logic": "capital_percentage",
  "timestamp": 1729543210000,
  "traderAddress": "0x7c3db723f1d4d8cb9c550095203b686cb11e5c6b",
  "startingCapital": 1000,
  "currentCapital": 1247.35,
  "totalTrades": 156,
  "copiedTrades": 98,
  "skippedTrades": 58,
  "totalInvested": 850.25,
  "currentValue": 1247.35,
  "realizedPnl": 100.50,
  "unrealizedPnl": 146.85,
  "totalPnl": 247.35,
  "roi": 24.74,
  "positions": [...]
}
```

## Переменные окружения для симуляций

Скрипт поддерживает следующие переменные в `.env`:

```bash
# Используются основным скриптом simulateProfitability.ts

# Адрес трейдера для симуляции
SIM_TRADER_ADDRESS = '0x7c3db723f1d4d8cb9c550095203b686cb11e5c6b'

# Период истории (дни)
SIM_HISTORY_DAYS = 30

# Минимальный размер ордера (USD)
SIM_MIN_ORDER_USD = 1.0

# Максимальное количество трейдов для загрузки
SIM_MAX_TRADES = 5000

# Тег для файла результата
SIM_RESULT_TAG = 'test'

# Мультипликатор (используется TRADE_MULTIPLIER из основного .env)
TRADE_MULTIPLIER = 2.0
```

**Примечание:** При использовании `npm run sim` эти переменные устанавливаются автоматически.

## Кэширование данных

Исторические трейды кэшируются в `trader_data_cache/`:

```
trader_data_cache/
├── 0x7c3db723f1d4d8cb9c550095203b686cb11e5c6b_30d_2025-10-22.json
└── 0x6bab41a0dc40d6dd4c1a915b8c01969479fd1292_30d_2025-10-22.json
```

**Преимущества:**
- Повторные симуляции выполняются мгновенно
- Экономия запросов к API Polymarket
- Кэш обновляется раз в день автоматически

**Очистка кэша:**
```bash
rm -rf trader_data_cache/
```

## Интерпретация результатов

### Хорошие показатели ✅

- **ROI > 15%:** Отличная доходность
- **Copy rate > 70%:** Большинство трейдов достаточно большие для копирования
- **Skip rate < 30%:** Не теряете много возможностей
- **Положительный Unrealized P&L:** Открытые позиции в плюсе

### Предупреждающие знаки ⚠️

- **ROI < 0%:** Убыточная стратегия
- **Skip rate > 50%:** Слишком много пропущенных трейдов (нужно больше капитала)
- **Copy rate < 50%:** Трейдер делает слишком маленькие трейды для вашего капитала
- **Большой отрицательный Unrealized P&L:** Открытые позиции в минусе

### Выбор оптимального мультипликатора

| Мультипликатор | Риск | Когда использовать |
|----------------|------|-------------------|
| 0.5x | Низкий | Тестирование, маленький капитал |
| 1.0x | Средний | Стандартное копирование |
| 2.0x | Высокий | Уверенность в трейдере |
| 3.0x+ | Очень высокий | Агрессивная стратегия, только с опытом |

## Советы и лучшие практики

### 1. Начинайте с консервативного подхода

```bash
# Первый запуск - стандартный тест
npm run sim standard

# Анализ результатов
npm run compare

# Если результаты хорошие - тест с более высоким мультипликатором
npm run sim custom <best_trader> 30 2.0
```

### 2. Проверяйте несколько периодов

```bash
# Краткосрочная производительность
npm run sim custom <trader> 7 1.0

# Среднесрочная
npm run sim custom <trader> 30 1.0

# Долгосрочная
npm run sim custom <trader> 90 1.0
```

### 3. Диверсифицируйте

Не полагайтесь на одного трейдера:

```bash
# Запустите симуляции для 3-5 трейдеров
npm run sim

# При выборе укажите несколько адресов
# 0xTrader1, 0xTrader2, 0xTrader3

# Сравните и выберите топ-2 или топ-3
npm run compare best 3
```

### 4. Учитывайте skip rate

Если skip rate > 40%, рассмотрите:
- Увеличение стартового капитала
- Снижение минимального размера ордера (если возможно)
- Выбор трейдера с большими позициями

### 5. Регулярно обновляйте анализ

```bash
# Запускайте симуляции раз в неделю
npm run sim standard

# Сравнивайте с предыдущими результатами
npm run compare
```

## Troubleshooting

### Ошибка: "No simulation results found"

```bash
# Запустите симуляцию сначала
npm run sim quick
```

### Ошибка: "Failed to fetch trades"

Проверьте:
- Интернет соединение
- Правильность адреса трейдера
- Rate limit API Polymarket (подождите 1-2 минуты)

### Симуляция работает слишком долго

```bash
# Используйте quick preset
npm run sim quick

# Или ограничьте количество трейдов
SIM_MAX_TRADES=500 npm run simulate
```

### Много пропущенных трейдов (high skip rate)

Причины:
1. Трейдер делает очень маленькие трейды
2. Ваш симулируемый капитал слишком мал

Решения:
- Увеличьте `STARTING_CAPITAL` в `simulateProfitability.ts`
- Используйте меньший мультипликатор (0.5x)
- Выберите другого трейдера с большими позициями

## Дополнительные команды

### Просмотр help

```bash
npm run sim help
npm run compare help
```

### Очистка старых результатов

```bash
# Удалить все результаты
rm -rf simulation_results/*.json

# Удалить результаты старше 7 дней
find simulation_results/ -name "*.json" -mtime +7 -delete
```

### Экспорт результатов

```bash
# Скопировать все результаты в архив
tar -czf simulation_results_$(date +%Y%m%d).tar.gz simulation_results/

# Или просто скопировать папку
cp -r simulation_results/ simulation_results_backup/
```

## Следующие шаги

После анализа симуляций:

1. **Выберите 2-3 лучших трейдера** по ROI и стабильности
2. **Определите оптимальный мультипликатор** для каждого
3. **Обновите `.env`** с выбранными настройками:
   ```bash
   USER_ADDRESSES = '0xTrader1, 0xTrader2, 0xTrader3'
   TRADE_MULTIPLIER = 1.5
   ```
4. **Запустите бота в preview mode** для финальной проверки:
   ```bash
   PREVIEW_MODE = true
   ```
5. **Начните с малого капитала** для реального тестирования
6. **Мониторьте результаты** и периодически запускайте новые симуляции

---

**Помните:** Прошлые результаты не гарантируют будущую доходность. Всегда начинайте с малого и постепенно увеличивайте капитал.

Удачных симуляций! 📊🚀
